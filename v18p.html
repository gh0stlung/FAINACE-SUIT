<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <meta name="theme-color" content="#050505" id="theme-color-meta" />
  <title>Finance Suite: Pro V43 (Fast)</title>
  
  <!-- Core Libraries -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['Space Grotesk', 'monospace'] },
          colors: {
            bg: 'var(--bg)',
            surface: 'var(--surface)',
            primary: 'var(--primary)', 
            accent: 'var(--accent)', 
            alert: '#ef4444', 
            warning: '#f97316', 
            success: '#84cc16', 
            info: '#0ea5e9', 
          },
          animation: {
            'pop': 'pop 0.35s cubic-bezier(0.2, 0.0, 0, 1) forwards',
            'slide-up': 'slideUp 0.35s cubic-bezier(0.2, 0.0, 0, 1) forwards',
            'fade-in': 'fadeIn 0.25s ease-out forwards',
            'cursor': 'cursor 1s infinite',
            'expand': 'expand 0.3s cubic-bezier(0.2, 0.0, 0, 1) forwards',
          },
          keyframes: {
            pop: { '0%': { transform: 'scale(0.96) translateY(8px)', opacity: '0' }, '100%': { transform: 'scale(1) translateY(0)', opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            expand: { '0%': { opacity: '0', transform: 'translateY(-10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            cursor: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0' } }
          }
        }
      }
    }
  </script>
  
  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom); }
    
    /* THEMES */
    body.theme-cosmic { --bg: #050505; --surface: #121212; --glass-bg: rgba(30, 30, 30, 0.5); --glass-border: rgba(255, 255, 255, 0.08); --primary: #b0fb5d; --text-main: #f2f2f2; --orb-opacity: 0.4; --shadow-color: rgba(0,0,0,0.4); }
    body.theme-knight { --bg: #000000; --surface: #0a0a0a; --glass-bg: #111111; --glass-border: #262626; --primary: #00e676; --text-main: #ffffff; --orb-opacity: 0; --shadow-color: rgba(0,0,0,0); }

    body { background-color: var(--bg); color: var(--text-main); -webkit-tap-highlight-color: transparent; overflow: hidden; user-select: none; transition: background 0.4s ease; margin: 0; }
    
    .noise-overlay { position: fixed; inset: 0; z-index: 9999; pointer-events: none; opacity: 0.015; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
    .bg-ambience { position: fixed; inset: 0; z-index: -1; background: linear-gradient(180deg, #0f0c29 0%, #1a1a2e 100%); opacity: 0.6; transition: opacity 0.5s; }
    body.theme-knight .bg-ambience { opacity: 0; }
    
    /* ORBS */
    .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: var(--orb-opacity); transition: opacity 0.5s; }
    .orb-1 { top: -10%; left: -10%; width: 60vw; height: 60vw; background: #6b4cff; animation: float 15s ease-in-out infinite; }
    .orb-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #05d5fa; animation: float 18s ease-in-out infinite reverse; }
    @keyframes float { 0% { transform: translate(0,0); } 50% { transform: translate(20px, 20px); } 100% { transform: translate(0,0); } }

    /* UI Components */
    .glass-card { background: var(--glass-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--glass-border); border-radius: 24px; transition: transform 0.2s cubic-bezier(0.2, 0.0, 0, 1); box-shadow: 0 4px 20px var(--shadow-color); }
    body.theme-knight .glass-card { backdrop-filter: none; background: #111; }
    .glass-card:active { transform: scale(0.98); }

    /* Modal System */
    .sheet-overlay { 
        position: fixed; inset: 0; z-index: 1005; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: flex; align-items: flex-end; 
        opacity: 0; animation: fadeIn 0.2s ease-out forwards; 
    }
    
    .sheet-content { 
        width: 100%; background: #141414; border-top: 1px solid rgba(255,255,255,0.1); border-radius: 32px 32px 0 0; display: flex; flex-direction: column; max-height: 90vh; overflow: hidden; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); 
        transform: translateY(100%); animation: slideUp 0.35s cubic-bezier(0.2, 0.0, 0, 1) forwards; 
    }

    .sheet-overlay.center-mode { align-items: center; justify-content: center; padding: 20px; }
    .sheet-overlay.center-mode .sheet-content { 
        border-radius: 32px; max-width: 340px; border: 1px solid rgba(255,255,255,0.1); 
        transform: scale(0.96) translateY(8px); opacity: 0; animation: pop 0.35s cubic-bezier(0.2, 0.0, 0, 1) forwards; 
    }

    .sheet-body { padding: 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }

    /* Input & Cursor */
    .custom-input { width: 100%; background: rgba(255,255,255,0.04); border: 1px solid transparent; color: white; padding: 14px 16px; border-radius: 16px; font-size: 18px; font-weight: 500; display: flex; align-items: center; transition: all 0.2s; min-height: 52px; white-space: pre; overflow: hidden; }
    .custom-input.active { border-color: var(--primary); background: rgba(255,255,255,0.08); box-shadow: 0 0 0 1px rgba(255,255,255,0.05); }
    .custom-input:empty:before { content: attr(placeholder); color: #666; }
    
    .input-cursor { display: inline-block; width: 2px; height: 20px; background: var(--primary); margin-left: 1px; animation: cursor 1s infinite; }
    
    /* Keyboard */
    .keyboard-area { background: #080808; border-top: 1px solid rgba(255,255,255,0.06); padding-bottom: env(safe-area-inset-bottom); width: 100%; min-height: 270px; display: flex; flex-direction: column; justify-content: flex-end; opacity: 0; transform: translateY(20px); transition: opacity 0.2s, transform 0.2s; }
    .keyboard-area.visible { opacity: 1; transform: translateY(0); }
    .key-row { display: flex; gap: 6px; margin-bottom: 6px; justify-content: center; padding: 0 6px; }
    .key-btn { height: 48px; flex: 1; min-width: 32px; background: rgba(255,255,255,0.06); color: white; border-radius: 10px; font-size: 20px; font-weight: 600; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; border-bottom: 1px solid rgba(0,0,0,0.3); }
    .key-btn:active { transform: translateY(1px); border-bottom: 0px; background: rgba(255,255,255,0.15); }
    .key-btn.active-cap { background: var(--primary); color: black; }
    
    /* Calendar & Components */
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; justify-items: center; width: 100%; }
    .date-cell { width: 100%; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 13px; font-weight: 600; color: #666; background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); transition: 0.2s; box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); }
    .date-cell.today { color: var(--primary); border: 1px solid rgba(255,255,255,0.1); }
    .date-cell.rent-day { border-color: var(--warning); color: var(--warning); background: rgba(249, 115, 22, 0.1); }
    .date-cell.selected { background: color-mix(in srgb, var(--primary) 15%, transparent); color: var(--primary); box-shadow: 0 0 12px rgba(176, 251, 93, 0.1); border: 1px solid var(--primary); }
    .date-amt { font-size: 9px; font-weight: 600; margin-top: 1px; color: #fda4af; max-width: 90%; overflow: hidden; white-space: nowrap; }

    .fab-fixed { position: fixed; bottom: 32px; right: 24px; width: 60px; height: 60px; background: var(--primary); color: black; border-radius: 22px; display: flex; align-items: center; justify-content: center; z-index: 50; box-shadow: 0 10px 25px rgba(0,0,0,0.4); transition: transform 0.3s cubic-bezier(0.2, 0.0, 0, 1); }
    .fab-fixed:active { transform: scale(0.92); }

    /* Budget Ring */
    .budget-circle { width: 100%; height: 100%; transform: rotate(-90deg); }
    .budget-circle circle { fill: none; stroke-width: 6; stroke-linecap: round; } 
    .budget-bg { stroke: rgba(255,255,255,0.08); }
    .budget-progress { transition: stroke-dasharray 0.8s cubic-bezier(0.2, 0.0, 0, 1), stroke 0.3s; }

    .text-title { font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; background: linear-gradient(135deg, #fff 0%, #aaa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    body.theme-knight .text-title { background: none; -webkit-text-fill-color: white; }
    
    /* Animation Utils */
    .record-expand-enter { opacity: 0; transform: translateY(-5px); transition: opacity 0.3s ease, transform 0.3s ease; }
    .record-expand-enter-active { opacity: 1; transform: translateY(0); }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes cursor { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
  </style>
</head>
<body class="theme-cosmic">
  <div class="noise-overlay"></div>
  <div id="root"></div>
  <script type="text/babel" data-presets="react,env">
    const { useState, useEffect, useRef, useMemo } = React;
    
    // --- SAFE LOCAL STORAGE ---
    const safeParse = (key, def) => { 
        try { 
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : def; 
        } catch(e) { 
            console.warn("Storage access failed", e);
            return def; 
        } 
    };
    
    const safeSet = (key, val) => {
        try { localStorage.setItem(key, typeof val === 'string' ? val : JSON.stringify(val)); } catch(e) {}
    };

    const getLocalISO = () => { const d = new Date(); const offset = d.getTimezoneOffset() * 60000; return new Date(d.getTime() - offset).toISOString().slice(0, 10); };
    const formatMonth = (iso) => new Date(iso + '-01').toLocaleString('default',{month:'long',year:'numeric'});
    const formatDateShort = (iso) => new Date(iso).toLocaleDateString('default', { day: 'numeric', month: 'short' });

    // --- ICONS ---
    const Icon = ({ name, size=24, className }) => {
      const p = { width:size, height:size, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round", className };
      switch (name) {
        case 'home': return <svg {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        case 'plus': return <svg {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        case 'trash': return <svg {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>;
        case 'x': return <svg {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        case 'chevronLeft': return <svg {...p}><polyline points="15 18 9 12 15 6"/></svg>;
        case 'chevronRight': return <svg {...p}><polyline points="9 18 15 12 9 6"/></svg>;
        case 'receipt': return <svg {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        case 'wallet': return <svg {...p}><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>;
        case 'backspace': return <svg {...p}><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></svg>;
        case 'pencil': return <svg {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        case 'calendar': return <svg {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        case 'arrowUp': return <svg {...p}><polyline points="18 15 12 9 6 15"/></svg>;
        case 'arrowDown': return <svg {...p}><polyline points="6 9 12 15 18 9"/></svg>;
        case 'shift': return <svg {...p}><path d="M12 2l-7 7h4v9h6v-9h4z"/></svg>;
        case 'bolt': return <svg {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        case 'chart': return <svg {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>;
        default: return null;
      }
    };

    // --- SHARED COMPONENTS ---
    const Input = ({ value, placeholder, onClick, active }) => (
        <div onClick={onClick} className={`custom-input ${active ? 'active' : ''}`}>
            <span className={!value ? "text-slate-500" : "text-white"}>{value || placeholder}</span>
            {active && <span className="input-cursor"></span>}
        </div>
    );

    const UnifiedModal = ({ isOpen, onClose, title, children, activeField, onKeyPress, onDateChange, dateValue, overrideView, setOverrideView, primaryAction, caps, toggleCaps, highlightDay }) => {
        if(!isOpen) return null;
        const [kbReady, setKbReady] = useState(false);
        const numKeys = ['1','2','3','4','5','6','7','8','9','.','0','back'];
        const textKeys = [['q','w','e','r','t','y','u','i','o','p'],['a','s','d','f','g','h','j','k','l'],['z','x','c','v','b','n','m','back'],['space']];
        const isNum = activeField?.type === 'number';
        const timerRef = useRef(null);
        const intervalRef = useRef(null);

        useEffect(() => { 
            let t;
            if (isOpen) t = setTimeout(() => setKbReady(true), 50); 
            else setKbReady(false);
            return () => { clearTimeout(t); clearTimeout(timerRef.current); clearInterval(intervalRef.current); };
        }, [isOpen]);

        const handleBackDown = (e) => {
            e.preventDefault();
            onKeyPress('back');
            timerRef.current = setTimeout(() => {
                intervalRef.current = setInterval(() => onKeyPress('back'), 60);
            }, 500); 
        };
        const handleBackUp = () => { clearTimeout(timerRef.current); clearInterval(intervalRef.current); };

        return (
            <div className="sheet-overlay input-mode" onClick={onClose}>
                <div className="sheet-content" onClick={e=>e.stopPropagation()}>
                    <div className="flex justify-between items-center p-4 border-b border-white/10">
                        <h2 className="text-lg font-bold text-white pl-2">{title}</h2>
                        <button onClick={onClose} className="p-2 bg-white/5 rounded-full"><Icon name="x" size={20}/></button>
                    </div>
                    <div className="sheet-body">{children}</div>
                    {activeField && (
                        <div className={`keyboard-area pt-2 ${kbReady ? 'visible' : ''}`}>
                             <div className="flex justify-between px-4 pb-2 border-b border-white/5 mb-2 h-8 items-center">
                                 {overrideView === 'calendar' ? (
                                    <button onClick={()=>setOverrideView(null)} className="text-slate-400 text-xs font-bold uppercase flex items-center gap-1"><Icon name="chevronLeft" size={14}/> Input</button>
                                 ) : <div></div>}
                                 {primaryAction && <button onClick={primaryAction} className="bg-primary text-black px-4 py-1 rounded-full text-xs font-bold shadow-lg active:scale-95 transition">SAVE</button>}
                             </div>
                             {overrideView === 'calendar' ? (
                                 <div className="px-4 pb-4 h-full flex-1 min-h-[300px]"><EmbeddedCalendar selectedDate={dateValue} onChange={onDateChange} highlightDay={highlightDay} /></div>
                             ) : isNum ? (
                                 <div className="grid grid-cols-3 gap-2 p-2 pb-6">
                                     {numKeys.map(k => (
                                        <button key={k} onClick={(e)=>k!=='back'&&onKeyPress(k)} 
                                            onPointerDown={k==='back'?handleBackDown:null} onPointerUp={k==='back'?handleBackUp:null} onPointerLeave={k==='back'?handleBackUp:null}
                                            className={`key-btn ${k==='back'?'bg-white/5 text-slate-400':''}`}>{k==='back'?<Icon name="backspace" size={24}/>:k}
                                        </button>
                                     ))}
                                 </div>
                             ) : (
                                 <div className="p-2 space-y-1 pb-6">
                                     {textKeys.map((row, i) => (
                                         <div key={i} className="key-row">
                                             {i===2 && <button onClick={toggleCaps} className={`key-btn ${caps?'active-cap':'bg-white/5'}`} style={{flex:0.5}}><Icon name="shift" size={18}/></button>}
                                             {row.map(k => <button key={k} onClick={()=>k!=='back'&&onKeyPress(k)} onPointerDown={k==='back'?handleBackDown:null} onPointerUp={k==='back'?handleBackUp:null} onPointerLeave={k==='back'?handleBackUp:null} className={`key-btn ${k==='space'?'flex-[2] text-xs':''}`}>{k==='back'?<Icon name="backspace" size={20}/>:k==='space'?'SPACE': (caps ? k.toUpperCase() : k)}</button>)}
                                         </div>
                                     ))}
                                 </div>
                             )}
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const EmbeddedCalendar = ({ selectedDate, onChange, highlightDay }) => {
        const [viewDate, setViewDate] = useState(new Date(selectedDate || new Date()));
        const [dir, setDir] = useState(null);
        const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();
        const startDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
        const today = getLocalISO();
        
        const changeMonth = (d) => { setDir(d>0?'right':'left'); setTimeout(()=>{ const x = new Date(viewDate); x.setMonth(x.getMonth() + d); setViewDate(x); setDir(null); },50); };
        const handleDayClick = (day) => {
            const m = String(viewDate.getMonth()+1).padStart(2,'0');
            const d = String(day).padStart(2,'0');
            onChange(`${viewDate.getFullYear()}-${m}-${d}`);
        };

        return (
            <div className="p-4 bg-white/5 rounded-3xl animate-pop h-full flex flex-col justify-center min-h-[300px]">
                <div className="flex justify-between items-center mb-4">
                   <div className="w-8"></div>
                   <div className="flex items-center gap-2">
                      <button onClick={()=>changeMonth(-1)}><Icon name="chevronLeft" size={16}/></button>
                      <span className="font-bold text-white transition-all">{viewDate.toLocaleString('default',{month:'long', year:'numeric'})}</span>
                      <button onClick={()=>changeMonth(1)}><Icon name="chevronRight" size={16}/></button>
                   </div>
                   <div className="w-8"></div>
                </div>
                <div className={`cal-grid ${dir==='left'?'animate-slide-left':dir==='right'?'animate-slide-right':''}`}>
                    {['S','M','T','W','T','F','S'].map(d=><div key={d} className="text-xs text-slate-500 font-bold">{d}</div>)}
                    {Array.from({length: startDay}).map((_,i)=><div key={`e-${i}`}></div>)}
                    {Array.from({length: daysInMonth}).map((_,i)=>{
                        const day = i+1;
                        const iso = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                        const isRentDay = highlightDay && day === Number(highlightDay);
                        return <div key={day} onClick={()=>handleDayClick(day)} className={`date-cell ${iso===selectedDate?'selected':iso===today?'today':isRentDay?'rent-day':''}`}>{day}</div>;
                    })}
                </div>
            </div>
        );
    };

    // --- APP: RENTBOOK ---
    const RentBook = ({ onBack }) => {
      const [tenants, setTenants] = useState(() => safeParse('rentTracker_v42', []));
      const [view, setView] = useState('dashboard');
      const [selId, setSelId] = useState(null);
      const [sheetMode, setSheetMode] = useState(null); 
      const [activeField, setActiveField] = useState(null); 
      const [overrideView, setOverrideView] = useState(null);
      const [caps, setCaps] = useState(false);
      
      const [tenantForm, setTenantForm] = useState({ name:'', houseNo:'', rent:'', deposit:'', rentDay:'1' });
      const [billForm, setBillForm] = useState({ oldUnit:'', newUnit:'', manualBill:'', monthISO: new Date().toISOString().slice(0,7) });
      const [payForm, setPayForm] = useState({ amount:'', date: getLocalISO() });
      const [expandedRecs, setExpandedRecs] = useState({});
      const [activeRecId, setActiveRecId] = useState(null);
      const [delTarget, setDelTarget] = useState(null);

      useEffect(() => safeSet('rentTracker_v42', tenants), [tenants]);

      const getTenantStats = useMemo(() => (tenant) => {
          if (!tenant || !tenant.records) return { balance: 0, currentStats: {}, displayRecords: [] };

          let totalBilled = 0;
          let totalPaid = 0;
          
          const sortedAsc = [...tenant.records].sort((a,b) => a.monthISO.localeCompare(b.monthISO));
          
          const processedRecords = sortedAsc.map(r => {
              const billTotal = (Number(r.rentAmount) || 0) + (Number(r.electricBill) || 0);
              const paidTotal = r.payments ? r.payments.reduce((acc, p) => acc + (Number(p.amount)||0), 0) : 0;
              totalBilled += billTotal;
              totalPaid += paidTotal;
              return { ...r, billTotal, paidTotal, runningBalance: totalBilled - totalPaid };
          });

          const displayRecords = processedRecords.reverse();
          const balance = totalBilled - totalPaid; 
          
          const latest = displayRecords[0];
          const currentStats = latest ? {
             rent: latest.rentAmount,
             elec: latest.electricBill,
             paid: latest.paidTotal,
             month: latest.month
          } : { rent: 0, elec: 0, paid: 0, month: '-' };

          return { balance, currentStats, displayRecords };
      }, [tenants]);

      useEffect(() => {
          const handlePop = (e) => {
              if (sheetMode) { setSheetMode(null); return; }
              if (view === 'details') { setView('dashboard'); setSelId(null); return; }
              onBack(); 
          };
          window.history.pushState(null, '', location.href); 
          window.addEventListener('popstate', handlePop);
          return () => window.removeEventListener('popstate', handlePop);
      }, [sheetMode, view]);

      const activate = (field, type) => { setActiveField({field, type}); setCaps(false); setOverrideView(null); }; 
      const handleKeyPress = (k) => {
          if(!activeField) return;
          const { field, type } = activeField;
          const update = (prev) => {
              let val = String(prev[field] || '');
              if(k==='back') return {...prev, [field]: val.slice(0,-1)};
              if(k==='space') return {...prev, [field]: val+' '};
              if(k==='.' && val.includes('.')) return prev; 
              if(type==='number' && val==='' && k==='0') return prev;
              return {...prev, [field]: val+(caps ? k.toUpperCase() : k)};
          }
          if(sheetMode.includes('Tenant')) setTenantForm(prev => update(prev));
          if(sheetMode === 'bill') setBillForm(prev => update(prev));
          if(sheetMode === 'pay') setPayForm(prev => update(prev));
      };

      const saveTenant = () => {
          if(!tenantForm.name) return;
          const newT = { name: tenantForm.name, houseNo: tenantForm.houseNo, baseRent: Number(tenantForm.rent)||0, securityDeposit: Number(tenantForm.deposit)||0, rentDay: tenantForm.rentDay };
          if(sheetMode === 'addTenant') setTenants([{ id: Date.now(), ...newT, records: [] }, ...tenants]);
          else setTenants(tenants.map(t => t.id === selId ? { ...t, ...newT } : t));
          setSheetMode(null); setActiveField(null);
      };

      const generateBill = () => {
          const tIdx = tenants.findIndex(t => t.id === selId);
          const tenant = tenants[tIdx];
          const prev = Number(billForm.oldUnit)||0; 
          const curr = Number(billForm.newUnit)||0; 
          const units = Math.max(0, curr - prev); 
          const manual = Number(billForm.manualBill); 
          const rent = Number(tenant.baseRent)||0; 
          const elec = manual > 0 ? manual : (units * 8); 
          
          const newRec = { 
              id: Date.now(), 
              monthISO: billForm.monthISO, 
              month: formatMonth(billForm.monthISO), 
              prevReading: prev, 
              currReading: curr, 
              units, 
              rentAmount: rent, 
              electricBill: elec, 
              totalBill: rent + elec,
              payments: [] 
          };
          
          const newTenants = [...tenants]; 
          newTenants[tIdx] = { ...tenant, records: [newRec, ...tenant.records] };
          setTenants(newTenants); setSheetMode(null); setActiveField(null);
      };

      const addPayment = () => {
          const tIdx = tenants.findIndex(t => t.id === selId);
          const rIdx = tenants[tIdx].records.findIndex(r => r.id === activeRecId);
          const amt = Number(payForm.amount);
          if(amt <= 0) return;

          const newTenants = [...tenants];
          newTenants[tIdx].records[rIdx].payments.push({ id: Date.now(), date: payForm.date, amount: amt });
          setTenants(newTenants); setSheetMode(null); setActiveField(null);
      };

      const deleteItem = () => {
          if (!delTarget) return;
          if (delTarget.type === 'tenant') { setTenants(prev => prev.filter(t => t.id !== delTarget.id)); setView('dashboard'); } 
          else if (delTarget.type === 'record') { const tIdx = tenants.findIndex(t => t.id === delTarget.pid); const t = tenants[tIdx]; const newTenants = [...tenants]; newTenants[tIdx] = { ...t, records: t.records.filter(r => r.id !== delTarget.id) }; setTenants(newTenants); } 
          else if (delTarget.type === 'payment') { const tIdx = tenants.findIndex(t => t.id === delTarget.pid); const t = tenants[tIdx]; const rIdx = t.records.findIndex(r => r.id === delTarget.recId); const newTenants = [...tenants]; newTenants[tIdx].records[rIdx].payments = t.records[rIdx].payments.filter(p => p.id !== delTarget.id); setTenants(newTenants); }
          setDelTarget(null);
      };

      const activeTenant = tenants.find(t => t.id === selId);
      const { balance, currentStats, displayRecords } = activeTenant ? getTenantStats(activeTenant) : { balance: 0, currentStats:{}, displayRecords:[] };
      const totalTenants = tenants.length;
      const dueCount = tenants.filter(t => getTenantStats(t).balance > 0).length;

      return (
          <div className="h-full flex flex-col animate-pop justify-center">
              <div className="pt-10 px-6 pb-2 flex justify-between items-center z-20">
                  <div className="flex items-center gap-4">
                      {view !== 'dashboard' && (
                          <button onClick={()=>{setView('dashboard'); setSelId(null)}} className="bg-white/10 p-2 rounded-full"><Icon name="chevronLeft" size={24}/></button>
                      )}
                      <h1 className="text-2xl text-title tracking-widest">RENTBOOK</h1>
                  </div>
                  {view==='dashboard' && <button onClick={onBack} className="bg-white/10 px-4 py-2 rounded-full text-xs font-bold text-slate-300">EXIT</button>}
                  {view==='details' && <button onClick={()=>{setTenantForm({name:activeTenant.name, houseNo:activeTenant.houseNo, rent:activeTenant.baseRent, deposit:activeTenant.securityDeposit, rentDay:activeTenant.rentDay}); setSheetMode('editTenant'); activate('name','text')}} className="p-2 bg-white/10 rounded-full"><Icon name="pencil" size={20}/></button>}
              </div>

              {view === 'dashboard' && (
                  <div className="px-6 mb-2">
                      <div className="glass-card p-4 flex justify-between items-center bg-gradient-to-r from-gray-900 to-gray-800">
                          <div className="text-center"><p className="text-[10px] text-slate-400 font-bold uppercase">Properties</p><p className="font-bold text-white text-xl">{totalTenants}</p></div>
                          <div className="text-center"><p className="text-[10px] text-slate-400 font-bold uppercase">Pending</p><p className="font-bold text-warning text-xl">{dueCount}</p></div>
                          <div className="text-center opacity-30"><Icon name="home" size={24}/></div>
                      </div>
                  </div>
              )}

              <div className="flex-1 overflow-y-auto px-5 pb-32 no-scroll z-10 pt-2">
                  {view === 'dashboard' && <h3 className="text-xs font-bold text-slate-600 uppercase tracking-widest mb-3 ml-1">Tenants</h3>}

                  {view === 'dashboard' && tenants.map((t) => {
                      const stats = getTenantStats(t);
                      return (
                          <div key={t.id} onClick={()=>{setSelId(t.id); setView('details')}} className="glass-card p-4 flex justify-between items-center animate-pop active:scale-95 transition mb-3">
                              <div className="flex items-center gap-4">
                                  <div className="w-12 h-12 rounded-full bg-gradient-to-br from-neutral-700 to-neutral-900 flex items-center justify-center font-bold text-white border border-white/10 text-lg">{(t.name && t.name[0]) || '?'}</div>
                                  <div>
                                      <div className="flex items-center gap-2">
                                          <h3 className="font-bold text-white leading-tight text-lg">{t.name}</h3>
                                      </div>
                                      <p className="text-xs text-slate-400 mt-1">{t.houseNo}</p>
                                  </div>
                              </div>
                              <div className="flex items-center gap-3">
                                  {stats.balance > 0 
                                      ? <span className="font-bold text-warning">â‚¹{stats.balance}</span> 
                                      : stats.balance < 0 
                                          ? <span className="font-bold text-success">â‚¹{Math.abs(stats.balance)} Cr</span>
                                          : <span className="font-bold text-info">Settled</span>
                                  }
                                  <button onClick={(e)=>{e.stopPropagation(); setDelTarget({type:'tenant', id:t.id})}} className="p-2 text-slate-500 hover:text-alert"><Icon name="trash" size={16}/></button>
                              </div>
                          </div>
                      )
                  })}

                  {view === 'details' && activeTenant && (
                      <div className="animate-slide-up space-y-4 pb-12">
                          
                          <div className="glass-card p-5 bg-gradient-to-b from-white/10 to-transparent relative backdrop-blur-xl border-b border-white/10">
                               <div className="text-center mb-4">
                                   <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Net Balance</p>
                                   <h1 className={`text-4xl font-mono font-bold ${balance > 0 ? 'text-alert' : balance < 0 ? 'text-success' : 'text-white'}`}>
                                       {balance > 0 ? `â‚¹${balance}` : balance < 0 ? `- â‚¹${Math.abs(balance)}` : 'Settled'}
                                   </h1>
                                   {balance > 0 && <p className="text-xs text-warning mt-1 font-bold">DUE</p>}
                                   {balance < 0 && <p className="text-xs text-success mt-1 font-bold">ADVANCE</p>}
                               </div>

                               <div className="mt-3 flex justify-center">
                                   <div className="bg-white/5 px-4 py-1.5 rounded-full border border-white/5 flex items-center gap-2">
                                       <span className="text-[10px] text-slate-500 uppercase tracking-widest opacity-80">Security Deposit</span>
                                       <span className="text-xs font-mono text-slate-300">â‚¹{activeTenant.securityDeposit || 0}</span>
                                   </div>
                               </div>
                               
                               <button onClick={()=>{setBillForm({oldUnit: displayRecords[0]?.currReading || '', newUnit:'', manualBill:'', monthISO: new Date().toISOString().slice(0,7)}); setSheetMode('bill'); activate('newUnit','number')}} className="w-full mt-4 bg-primary text-black font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">+ NEW BILL</button>
                          </div>

                          <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest px-2">History</h3>

                          <div className="space-y-3">
                              {displayRecords.map((r, index) => {
                                  const isExp = expandedRecs[r.id];
                                  return (
                                      <div key={r.id} className="glass-card overflow-hidden transition-all duration-300">
                                          <div onClick={()=>setExpandedRecs(p=>({...p, [r.id]:!isExp}))} className="p-4 flex justify-between items-center cursor-pointer active:bg-white/5">
                                              <div>
                                                  <h4 className="font-bold text-white text-sm">{r.month}</h4>
                                                  <div className="flex gap-2 mt-1">
                                                      <span className="text-[10px] bg-white/10 px-2 rounded text-white font-bold">Bill: â‚¹{r.billTotal}</span>
                                                  </div>
                                              </div>
                                              <div className="text-right">
                                                  <p className="text-[9px] text-slate-500 uppercase font-bold">Balance After</p>
                                                  <p className={`font-mono font-bold ${r.runningBalance>0?'text-warning':r.runningBalance<0?'text-success':'text-slate-400'}`}>
                                                      {r.runningBalance > 0 ? `â‚¹${r.runningBalance}` : r.runningBalance < 0 ? `Cr â‚¹${Math.abs(r.runningBalance)}` : '0'}
                                                  </p>
                                              </div>
                                          </div>
                                          
                                          {isExp && (
                                              <div className="bg-white/5 border-t border-white/5 animate-expand origin-top">
                                                  <div className="p-4 text-sm space-y-3">
                                                      
                                                      <div className="flex justify-between items-center p-3 rounded-xl bg-blue-500/5 border border-blue-500/10 shadow-[0_0_15px_rgba(59,130,246,0.1)] mb-2 transition hover:bg-blue-500/10">
                                                           <span className="text-xs text-blue-200/70 font-medium uppercase tracking-wide">Rent</span>
                                                           <span className="font-mono font-bold text-blue-100 text-sm">â‚¹{r.rentAmount}</span>
                                                      </div>

                                                      <div className="flex justify-between items-center p-3 rounded-xl bg-orange-500/5 border border-orange-500/10 shadow-[0_0_15px_rgba(249,115,22,0.1)] mb-4 transition hover:bg-orange-500/10">
                                                           <div className="flex items-center gap-2">
                                                               <Icon name="bolt" size={14} className="text-orange-400"/>
                                                               <span className="text-xs text-orange-200/70 font-medium uppercase tracking-wide">Electric</span>
                                                           </div>
                                                           <div className="text-right">
                                                               <span className="font-mono font-bold text-orange-100 text-sm">â‚¹{r.electricBill}</span>
                                                               <div className="text-[9px] text-orange-500/60 font-mono">({r.currReading} - {r.prevReading})</div>
                                                           </div>
                                                      </div>
                                                      
                                                      <div className="space-y-2 pt-1">
                                                          <p className="text-[10px] font-bold text-slate-500 uppercase">Payments</p>
                                                          {r.payments.length === 0 ? <p className="text-xs text-slate-600 italic">No payments recorded</p> : 
                                                              r.payments.map(p => (
                                                                  <div key={p.id} className="flex justify-between items-center bg-black/20 p-2 rounded-lg text-xs">
                                                                      <span className="text-slate-400 font-mono">{formatDateShort(p.date)}</span>
                                                                      <div className="flex items-center gap-2"><span className="font-bold text-success">â‚¹{p.amount}</span><button onClick={()=>setDelTarget({type:'payment', id:p.id, pid:activeTenant.id, recId:r.id})} className="text-slate-600 hover:text-alert"><Icon name="trash" size={12}/></button></div>
                                                                  </div>
                                                              ))
                                                          }
                                                      </div>
                                                      
                                                      <div className="flex gap-2 pt-2">
                                                          <button onClick={(e)=>{e.stopPropagation(); setDelTarget({type:'record', id:r.id, pid:activeTenant.id})}} className="flex-1 py-3 bg-red-500/10 text-alert rounded-xl font-bold text-[10px] border border-red-500/20 active:scale-95 transition">DELETE BILL</button>
                                                          <button onClick={()=>{setActiveRecId(r.id); setPayForm({amount:balance > 0 ? balance : '',date:getLocalISO()}); setSheetMode('pay'); activate('amount','number')}} className="flex-[2] py-3 bg-white/10 text-white rounded-xl font-bold text-[10px] active:scale-95 transition hover:bg-white/20">ADD PAYMENT</button>
                                                      </div>
                                                  </div>
                                              </div>
                                          )}
                                      </div>
                                  )
                              })}
                          </div>
                      </div>
                  )}
              </div>
              
              {view==='dashboard' && <button onClick={()=>{setTenantForm({name:'',houseNo:'',rent:'',deposit:'',rentDay:'1'}); setSheetMode('addTenant'); activate('name','text')}} className="fab-fixed"><Icon name="plus" size={32}/></button>}

              <UnifiedModal 
                  isOpen={!!sheetMode} onClose={()=>setSheetMode(null)} title={sheetMode==='pay'?'Record Payment':sheetMode==='bill'?'New Bill':'Property'}
                  activeField={activeField} onKeyPress={handleKeyPress} overrideView={overrideView} setOverrideView={setOverrideView}
                  onDateChange={(d)=>setPayForm(p=>({...p, date:d}))} dateValue={payForm.date}
                  primaryAction={()=>{ if(sheetMode==='pay') addPayment(); else if(sheetMode==='bill') generateBill(); else saveTenant(); }} caps={caps} toggleCaps={()=>setCaps(!caps)}
                  highlightDay={activeTenant?.rentDay} 
              >
                  {(sheetMode === 'addTenant' || sheetMode === 'editTenant') && (
                      <div className="space-y-3">
                          <Input value={tenantForm.name} placeholder="Name" onClick={()=>activate('name','text')} active={activeField?.field==='name'} />
                          <Input value={tenantForm.houseNo} placeholder="House No" onClick={()=>activate('houseNo','text')} active={activeField?.field==='houseNo'} />
                          <div className="flex gap-2"><Input value={tenantForm.rent} placeholder="Rent â‚¹" onClick={()=>activate('rent','number')} active={activeField?.field==='rent'} /><Input value={tenantForm.rentDay} placeholder="Due Day" onClick={()=>activate('rentDay','number')} active={activeField?.field==='rentDay'} /></div>
                          <Input value={tenantForm.deposit} placeholder="Deposit (Info only)" onClick={()=>activate('deposit','number')} active={activeField?.field==='deposit'} />
                      </div>
                  )}
                  {sheetMode === 'bill' && (
                      <div className="space-y-3">
                          <div className="flex justify-between items-center bg-white/5 p-3 rounded-xl mb-2">
                               <button onClick={()=>{let [y,m]=billForm.monthISO.split('-'); m--; if(m<1){m=12;y--}; setBillForm({...billForm, monthISO:`${y}-${String(m).padStart(2,'0')}`})}}><Icon name="chevronLeft" size={20}/></button>
                               <span className="font-bold text-white">{formatMonth(billForm.monthISO)}</span>
                               <button onClick={()=>{let [y,m]=billForm.monthISO.split('-'); m++; if(m>12){m=1;y++}; setBillForm({...billForm, monthISO:`${y}-${String(m).padStart(2,'0')}`})}}><Icon name="chevronRight" size={20}/></button>
                          </div>
                          <div className="flex gap-2"><Input value={billForm.oldUnit} placeholder="Old Reading" onClick={()=>activate('oldUnit','number')} active={activeField?.field==='oldUnit'} /><Input value={billForm.newUnit} placeholder="New Reading" onClick={()=>activate('newUnit','number')} active={activeField?.field==='newUnit'} /></div>
                          <Input value={billForm.manualBill} placeholder="Manual Elec (Opt)" onClick={()=>activate('manualBill','number')} active={activeField?.field==='manualBill'} />
                      </div>
                  )}
                  {sheetMode === 'pay' && (
                      <div className="space-y-6 pt-4">
                          <div className="text-center">
                              <p className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Amount</p>
                              <div onClick={()=>activate('amount','number')} className={`text-5xl font-mono font-bold text-center py-4 border-b border-white/10 ${activeField?.field==='amount' ? 'text-white' : 'text-primary'}`}>â‚¹{payForm.amount || '0'}{activeField?.field==='amount' && <span className="input-cursor"></span>}</div>
                          </div>
                          <div onClick={()=>{setOverrideView('calendar')}} className="flex items-center justify-center gap-2 text-white py-4 bg-white/5 rounded-xl border border-white/5 active:scale-95 transition cursor-pointer">
                              <Icon name="calendar" size={16}/> {formatDateShort(payForm.date)} <span className="text-xs text-slate-400">(Tap to change)</span>
                          </div>
                      </div>
                  )}
              </UnifiedModal>

              {delTarget && <div className="sheet-overlay center-mode" onClick={()=>setDelTarget(null)}><div className="glass-card p-6 w-full max-w-xs text-center"><h2 className="text-xl font-bold text-white mb-4">Confirm Delete?</h2><div className="flex gap-3"><button onClick={()=>setDelTarget(null)} className="flex-1 py-3 rounded-xl bg-white/10 text-white">Cancel</button><button onClick={deleteItem} className="flex-1 py-3 rounded-xl bg-alert text-white font-bold">Delete</button></div></div></div>}
          </div>
      )
    };

    // --- APP: WALLET ---
    const Wallet = ({ onBack }) => {
        const [txs, setTxs] = useState(() => safeParse('walletTxs_v42', []));
        const [budget, setBudget] = useState(() => safeParse('budget_v42', 5000));
        const [sheetMode, setSheetMode] = useState(null);
        const [activeField, setActiveField] = useState(null);
        const [form, setForm] = useState({ id: null, amt:'', note:'', cat:'veg' });
        const [viewDate, setViewDate] = useState(new Date());
        const [selDate, setSelDate] = useState(getLocalISO()); 
        const [delId, setDelId] = useState(null);
        const [caps, setCaps] = useState(false);
        const [direction, setDirection] = useState(null);

        useEffect(() => safeSet('walletTxs_v42', txs), [txs]);
        useEffect(() => safeSet('budget_v42', budget), [budget]);

        useEffect(() => {
            const handlePop = (e) => {
                if (sheetMode) { setSheetMode(null); return; }
                onBack();
            };
            window.history.pushState(null, '', location.href); 
            window.addEventListener('popstate', handlePop);
            return () => window.removeEventListener('popstate', handlePop);
        }, [sheetMode]);

        const changeMonth = (dir) => { setDirection(dir > 0 ? 'right' : 'left'); setTimeout(() => { const d = new Date(viewDate); d.setMonth(d.getMonth() + dir); setViewDate(d); setDirection(null); }, 50); };
        const activate = (field, type) => { setActiveField({field, type}); setCaps(false); } 
        const handleKeyPress = (k) => {
            if(!activeField) return;
            const { field, type } = activeField;
            if(sheetMode === 'budget') { 
                if(k==='back') setBudget(Number(String(budget).slice(0,-1))); 
                else if(k!=='space') { 
                    const next = String(budget || ''); 
                    if(k==='.' && next.includes('.')) return;
                    setBudget(Number(next + k) || 0); 
                }
                return; 
            }
            setForm(p => {
                let val = String(p[field] || '');
                if(k==='back') val = val.slice(0,-1);
                else if(k==='space') val += ' ';
                else if(k==='.' && val.includes('.')) return p;
                else val += (caps?k.toUpperCase():k);
                return {...p, [field]: val};
            });
        };

        const saveTx = () => { if(!form.amt) { setForm(p=>({...p, amt:''})); return; } const tx = { id: form.id || Date.now(), amount: Number(form.amt), category: form.cat, title: form.note || form.cat, date: selDate }; if (form.id) setTxs(txs.map(t => t.id === form.id ? tx : t)); else setTxs([tx, ...txs]); setSheetMode(null); setActiveField(null); };

        const Cats = [
            {id:'veg',i:'ðŸ¥¦',l:'Veg'}, {id:'grocery',i:'ðŸ›’',l:'Grocery'},
            {id:'med',i:'ðŸ’Š',l:'Med'}, {id:'petrol',i:'â›½',l:'Petrol'},
            {id:'shop',i:'ðŸ›ï¸',l:'Shop'}, {id:'house',i:'ðŸ ',l:'House'}
        ];
        const monthStr = viewDate.toISOString().slice(0,7);
        const spent = txs.filter(t=>t.date.startsWith(monthStr)).reduce((a,b)=>a+b.amount,0);
        const remaining = budget - spent;
        const pct = budget > 0 ? Math.min((spent/budget)*100, 100) : 0;
        
        const radius = 22; 
        const circumference = 2 * Math.PI * radius;
        const dash = (pct / 100) * circumference;
        const hue = Math.max(0, 120 - (pct * 1.2));
        const budgetColor = `hsl(${hue}, 80%, 55%)`;

        const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();
        const startDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();

        // --- REPORT DATA CALCULATION ---
        const trend = [];
        for(let i=5; i>=0; i--) {
            const d = new Date(viewDate.getFullYear(), viewDate.getMonth() - i, 1);
            const mStr = d.toISOString().slice(0,7);
            const sum = txs.filter(t => t.date.startsWith(mStr)).reduce((a,b)=>a+b.amount,0);
            trend.push({ m: mStr, val: sum, lbl: d.toLocaleString('default',{month:'narrow'}) });
        }
        const maxVal = Math.max(...trend.map(t=>t.val)) || 1;
        const trendData = trend.map(t => ({ ...t, pct: (t.val/maxVal)*100 }));

        const currTxs = txs.filter(t => t.date.startsWith(monthStr));
        const totalMonth = currTxs.reduce((a,b)=>a+b.amount,0) || 1;
        const catData = Cats.map(c => {
            const sum = currTxs.filter(t => t.category === c.id).reduce((a,b)=>a+b.amount,0);
            return { ...c, total: sum, pct: (sum/totalMonth)*100, icon: c.i, label: c.l };
        }).filter(c => c.total > 0).sort((a,b) => b.total - a.total);

        return (
            <div className="h-full flex flex-col animate-pop justify-center">
                <div className="pt-10 px-6 pb-2 flex justify-between items-center z-20">
                    <h1 className="text-2xl text-title tracking-widest animate-fade-in">WALLET</h1>
                    <button onClick={onBack} className="bg-white/10 p-2 rounded-full text-slate-300"><Icon name="home" size={20}/></button>
                </div>

                <div className="px-6 flex items-center justify-between mb-2">
                     <div className="flex bg-white/5 rounded-full p-1 items-center backdrop-blur-md">
                         <button onClick={()=>changeMonth(-1)} className="p-2 text-slate-400 hover:text-white"><Icon name="chevronLeft" size={16}/></button>
                         <span className="px-3 font-bold text-white text-sm transition-all">{viewDate.toLocaleString('default',{month:'long', year:'numeric'})}</span>
                         <button onClick={()=>changeMonth(1)} className="p-2 text-slate-400 hover:text-white"><Icon name="chevronRight" size={16}/></button>
                     </div>
                     <button onClick={()=>setSheetMode('report')} className="bg-white/10 p-2 rounded-full text-slate-300 backdrop-blur-md active:scale-95 transition"><Icon name="chart" size={20}/></button>
                </div>

                <div className="px-6 mb-4">
                    <div className="glass-card p-3 rounded-[28px] relative overflow-hidden">
                        <div className="flex justify-between items-center px-4 py-1">
                             <div><p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">Spent</p><h2 className="text-3xl font-mono font-bold text-white tracking-tighter">â‚¹{spent}</h2></div>
                             
                             <div className="w-20 h-20 relative" onClick={()=>{setSheetMode('budget'); activate('budget','number')}}>
                                <svg viewBox="0 0 50 50" className="budget-circle">
                                    <circle cx="25" cy="25" r="22" className="budget-bg" />
                                    <circle cx="25" cy="25" r="22" className="budget-progress" strokeDasharray={`${dash} ${circumference}`} style={{stroke: budgetColor}} />
                                </svg>
                                <div className="absolute inset-0 flex flex-col items-center justify-center">
                                    <span className="text-[10px] font-bold" style={{color: budgetColor}}>â‚¹{remaining}</span>
                                    <span className="text-[8px] text-slate-500 font-bold uppercase mt-1">/ {budget}</span>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto px-6 pb-32 no-scroll space-y-6">
                    <div className="glass-card p-4">
                        <div className={`cal-grid ${direction==='left'?'animate-slide-left':direction==='right'?'animate-slide-right':''}`}>
                            {['S','M','T','W','T','F','S'].map(d=><div key={d} className="text-[10px] text-slate-500 font-bold text-center">{d}</div>)}
                            {Array.from({length: startDay}).map((_,i)=><div key={'b'+i}></div>)}
                            {Array.from({length: daysInMonth}).map((_,i)=>{
                                const d = i+1; const iso = `${monthStr}-${String(d).padStart(2,'0')}`;
                                const daySpent = txs.filter(t=>t.date===iso).reduce((a,b)=>a+b.amount,0);
                                return (
                                    <div key={d} onClick={()=>setSelDate(iso)} className={`date-cell ${iso===selDate?'selected':iso===getLocalISO()?'today':''}`}>
                                        <span>{d}</span>
                                        {daySpent>0 && <span className="date-amt">â‚¹{daySpent}</span>}
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    <div>
                        <div className="space-y-3">
                            {txs.filter(t=>t.date===selDate).map(t => (
                                <div key={t.id} className="glass-card p-4 flex justify-between items-center animate-slide-up">
                                    <div className="flex items-center gap-4">
                                        <div className="text-2xl">{Cats.find(c=>c.id===t.category)?.i || 'ðŸ“¦'}</div>
                                        <div><div className="font-bold text-white">{t.title}</div><div className="text-xs text-slate-500 font-mono">{t.category}</div></div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div onClick={()=>{setForm({id:t.id, amt:t.amount, note:t.title, cat:t.category}); setSheetMode('edit'); activate('amt','number')}} className="font-mono font-bold text-white cursor-pointer active:scale-95 transition">â‚¹{t.amount}</div>
                                        <button onClick={()=>setDelId(t.id)} className="p-2 text-slate-600 hover:text-alert"><Icon name="trash" size={16}/></button>
                                    </div>
                                </div>
                            ))}
                            {txs.filter(t=>t.date===selDate).length === 0 && (
                                <div className="text-center text-slate-600 py-4 text-xs italic border border-dashed border-white/10 rounded-xl">No expenses on {selDate}</div>
                            )}
                        </div>
                    </div>
                </div>

                <button onClick={()=>{setForm({id:null, amt:'', note:'', cat:'veg'}); setSheetMode('add'); activate('amt','number')}} className="fab-fixed"><Icon name="plus" size={32}/></button>

                <UnifiedModal 
                   isOpen={!!sheetMode} onClose={()=>setSheetMode(null)} 
                   title={sheetMode==='budget'?'Set Limit':sheetMode==='edit'?'Edit Expense':sheetMode==='report'?'Monthly Report':'Add Expense'}
                   activeField={activeField} onKeyPress={handleKeyPress} primaryAction={()=>{ if(sheetMode==='budget') setSheetMode(null); else saveTx(); }}
                   caps={caps} toggleCaps={()=>setCaps(!caps)}
                >
                    {sheetMode === 'report' ? (
                        <div className="space-y-6 pt-2">
                            <div>
                                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">6 Month Trend</h3>
                                <div className="flex items-end justify-between h-32 gap-2 px-2">
                                    {trendData.map((d,i) => (
                                        <div key={i} className="flex flex-col items-center flex-1 gap-2">
                                            <div className="w-full bg-white/5 rounded-t-sm relative group h-full flex flex-col justify-end">
                                                <div className="w-full bg-primary/20 rounded-t-sm transition-all duration-500 relative" style={{height: `${d.pct}%`}}>
                                                     <div className="absolute bottom-0 w-full bg-primary shadow-[0_0_15px_var(--primary)] opacity-20 h-1"></div>
                                                </div>
                                            </div>
                                            <span className="text-[9px] text-slate-500 font-mono">{d.lbl}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Category Breakdown</h3>
                                <div className="space-y-3">
                                     {catData.length === 0 ? <p className="text-xs text-slate-600 italic text-center py-4">No data for this month</p> : 
                                         catData.map(c => (
                                         <div key={c.id}>
                                            <div className="flex justify-between text-xs mb-1">
                                                <span className="text-white flex items-center gap-2">{c.icon} {c.label}</span>
                                                <span className="font-mono">â‚¹{c.total}</span>
                                            </div>
                                            <div className="h-2 bg-white/5 rounded-full overflow-hidden">
                                                <div className="h-full bg-gradient-to-r from-primary to-emerald-400 rounded-full" style={{width: `${c.pct}%`}}></div>
                                            </div>
                                         </div>
                                     ))}
                                </div>
                            </div>
                        </div>
                    ) : sheetMode==='budget' ? (
                        <div className="text-center py-6">
                            <div onClick={()=>activate('budget','number')} className={`text-6xl font-mono font-bold text-center py-4 ${activeField?.field==='budget'?'text-primary':'text-white'}`}>â‚¹{budget}{activeField?.field==='budget' && <span className="input-cursor"></span>}</div>
                        </div>
                    ) : (
                        <div className="space-y-5 pt-2">
                             <div className="text-center">
                                 <p className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Amount</p>
                                 <div onClick={()=>activate('amt','number')} className={`text-5xl font-mono font-bold text-center py-2 border-b border-white/10 ${activeField?.field==='amt'?'text-white':'text-primary'}`}><span className="text-2xl align-top">â‚¹</span>{form.amt || '0'}{activeField?.field==='amt' && <span className="input-cursor"></span>}</div>
                             </div>
                             <div className="grid grid-cols-6 gap-2">
                                 {Cats.map(c => (
                                     <button key={c.id} onClick={()=>setForm({...form, cat:c.id})} className={`aspect-square rounded-xl flex items-center justify-center text-xl border transition ${form.cat===c.id?'border-primary bg-primary/20 scale-105':'border-white/5 bg-white/5'}`}>{c.i}</button>
                                 ))}
                             </div>
                             <Input value={form.note} placeholder="Note" onClick={()=>activate('note','text')} active={activeField?.field==='note'} />
                        </div>
                    )}
                </UnifiedModal>

                {delId && <div className="sheet-overlay center-mode" onClick={()=>setDelId(null)}><div className="glass-card p-6 w-full max-w-xs text-center"><h2 className="text-lg font-bold text-white mb-4">Delete Expense?</h2><div className="flex gap-3"><button onClick={()=>setDelId(null)} className="flex-1 py-3 rounded-xl bg-white/10 text-white">Cancel</button><button onClick={()=>{setTxs(txs.filter(t=>t.id!==delId)); setDelId(null)}} className="flex-1 py-3 rounded-xl bg-alert text-white font-bold">Delete</button></div></div></div>}
            </div>
        )
    };

    const Launcher = ({ onSelect, toggleTheme, theme }) => (
        <div className="h-full flex flex-col p-8 relative z-10 animate-pop">
            <div className="mt-12 mb-auto text-center">
                 <h1 className="text-5xl font-black text-white tracking-tighter leading-none">FINANCE<br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-primary via-emerald-400 to-primary">SUITE</span></h1>
            </div>
            
            <div className="flex-1 flex flex-col justify-center items-center w-full">
                <div className="w-full max-w-xs space-y-4">
                    <div onClick={()=>onSelect('rent')} className={`glass-card p-6 flex items-center gap-6 cursor-pointer hover:bg-white/5 active:scale-95 transition border-l-4 border-l-accent`}>
                        <div className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl flex items-center justify-center text-white shadow-lg"><Icon name="receipt" size={28}/></div>
                        <div><h3 className="text-2xl font-bold text-white">RentBook</h3><p className="text-xs text-slate-400 uppercase tracking-widest mt-1">Properties</p></div>
                    </div>
                    <div onClick={()=>onSelect('wallet')} className={`glass-card p-6 flex items-center gap-6 cursor-pointer hover:bg-white/5 active:scale-95 transition border-l-4 border-l-primary`}>
                        <div className="w-14 h-14 bg-gradient-to-br from-teal-500 to-emerald-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><Icon name="wallet" size={28}/></div>
                        <div><h3 className="text-2xl font-bold text-white">Wallet</h3><p className="text-xs text-slate-400 uppercase tracking-widest mt-1">Tracker</p></div>
                    </div>
                </div>
            </div>

            <div className="mb-8 flex justify-center">
                 <div className="flex bg-white/10 p-1 rounded-full backdrop-blur-md shadow-2xl">
                    <button onClick={()=>toggleTheme('cosmic')} className={`px-6 py-2 rounded-full text-xs font-bold transition ${theme==='cosmic'?'bg-accent text-white shadow-lg':'text-slate-400'}`}>COSMIC</button>
                    <button onClick={()=>toggleTheme('knight')} className={`px-6 py-2 rounded-full text-xs font-bold transition ${theme==='knight'?'bg-white text-black shadow-lg':'text-slate-400'}`}>KNIGHT</button>
                </div>
            </div>
        </div>
    );

    const App = () => {
      const [app, setApp] = useState('launcher');
      const [theme, setTheme] = useState(() => safeParse('theme_pref', 'cosmic'));
      
      useEffect(() => { 
          document.body.className = `theme-${theme}`; 
          safeSet('theme_pref', theme);
          const meta = document.getElementById('theme-color-meta');
          if(meta) meta.setAttribute('content', theme === 'cosmic' ? '#050505' : '#000000');
      }, [theme]);
      
      useEffect(() => {
        const handlePop = (e) => setApp(e.state?.app || 'launcher');
        window.addEventListener('popstate', handlePop);
        return () => window.removeEventListener('popstate', handlePop);
      }, []);
      
      const open = (name) => { setApp(name); window.history.pushState({app:name}, '', `#${name}`); }
      
      return (
        <div className="w-full h-screen relative overflow-hidden bg-transparent font-sans flex items-center justify-center">
           <div className="bg-ambience"></div><div className="orb orb-1"></div><div className="orb orb-2"></div>
           <div className="w-full h-full max-w-md mx-auto relative">
               {app==='launcher' && <Launcher onSelect={open} toggleTheme={setTheme} theme={theme} />}
               {app==='rent' && <RentBook onBack={()=>open('launcher')} />}
               {app==='wallet' && <Wallet onBack={()=>open('launcher')} />}
           </div>
        </div>
      );
    }

    // --- CRASH HANDLER ---
    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false, err: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, err: error }; }
      render() {
        if (this.state.hasError) {
          return <div className="p-8 text-white text-center font-mono"><h1>App Crashed</h1><p className="text-xs text-red-400 mt-4">{this.state.err?.message}</p><button onclick="localStorage.clear();location.reload()" className="mt-4 bg-white/10 px-4 py-2 rounded">Reset App</button></div>;
        }
        return this.props.children; 
      }
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ErrorBoundary><App /></ErrorBoundary>);
  </script>
</body>
</html>